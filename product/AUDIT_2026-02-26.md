# Yggdrasil Platform — Full Feature Audit

**Date:** 2026-02-26
**Auditor:** Automated deep-scan across all three repositories
**Repositories:** `yggdrasil` (ERP backend + web-app), `mimirlabs` (marketing site + portal), `docs`
**Overall Readiness:** ~65% sell/use ready

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Blocking Production Issues](#2-blocking-production-issues)
3. [Marketing Site & Portal (mimirlabs)](#3-marketing-site--portal-mimirlabs)
4. [ERP Web Application (yggdrasil/web-app)](#4-erp-web-application-yggdrasilweb-app)
5. [ERP Backend (yggdrasil/server)](#5-erp-backend-yggdrasilserver)
6. [Business Flow Gaps](#6-business-flow-gaps)
7. [Module Scorecards](#7-module-scorecards)
8. [Testing & CI/CD](#8-testing--cicd)
9. [Infrastructure & DevOps](#9-infrastructure--devops)
10. [Prioritized Action Items](#10-prioritized-action-items)

---

## 1. Executive Summary

The Yggdrasil ERP platform spans three repositories with a C++ backend, Qt 6 desktop client, Next.js 15 web-app, and a separate Next.js 14 marketing site with customer portal. The architecture is sound — multi-tenant, event-driven, with 126 database tables and 150+ API endpoints.

**What works well:**
- All 14 business modules have basic CRUD via the C++ server
- PLM has advanced features (EBOM/MBOM, revision control, option groups, ECOs)
- Desktop client is functional with all modules
- Marketing site has complete public pages (pricing, features, modules, checkout)
- Portal has working team management, settings, and support

**What's broken or missing:**
- Marketing site DAL uses in-memory Maps (data lost on restart)
- Production deployment crashing (missing `sharp`, stale build chunks)
- No email system (invitations, password resets, notifications all log to stdout)
- No WebSocket client in either web app (server exposes WS on :8081)
- Hardcoded dashboard stats and health metrics
- No file attachment support anywhere
- No print/PDF generation
- Key business flows broken (Quote→SO→Invoice requires manual re-entry)
- Thin test coverage (3 test files in web-app, 21 unit tests in server)

---

## 2. Blocking Production Issues

These must be fixed before any user can use the platform:

### 2.1 Marketing Site Crashes (FIXED)

| Issue | Root Cause | Fix |
|-------|-----------|-----|
| `/next/image` returns 400 | `sharp` not in dependencies | **FIXED** — Added `sharp@0.34.5` |
| Layout chunk 404 → "Something Went Wrong" | Stale `.next/` build on server | Needs `npm ci && npm run build` on server |
| PM2 config missing | No ecosystem.config.cjs | **FIXED** — Added PM2 ecosystem config |

**After deploying:** Run `npm ci && npm run build && pm2 start ecosystem.config.cjs` on the production server.

### 2.2 DAL Is 100% In-Memory

**File:** `mimirlabs/website/src/lib/dal.ts`

The entire data access layer uses `globalThis` Maps. Every restart loses all data — organizations, users, subscriptions, tickets, everything. The Prisma schema defines 13 models but zero are used at runtime.

**In-memory stores:**
- `__ygg_orgs` — Organizations
- `__ygg_users` — Users (keyed by email)
- `__ygg_invitations` — Team invitations
- `__ygg_tickets` — Support tickets
- `__ygg_service_reqs` — Service requests
- `__ygg_module_acts` — Module activations
- `__ygg_subscriptions` — Subscriptions
- `__ygg_reset_tokens` — Password reset tokens
- `__ygg_tenant_creds` — Tenant credentials

**Models in Prisma schema with ZERO DAL functions:**
- `Order` — No order creation after checkout
- `Contract` — No contract tracking after BoldSign
- `TenantConnection` — No sidecar connection tracking
- `AuditLog` — No audit logging anywhere

### 2.3 No Email System

Every email-sending operation logs to stdout instead of actually sending:
- Password reset emails → `console.log("Reset token:", token)`
- Team invitations → `console.log("Invitation link:", url)`
- Support ticket acknowledgments → not implemented
- Order confirmations → not implemented
- Contract signing notifications → not implemented

`nodemailer` is in dependencies but only wired up in `/api/contact` (contact form), and even that falls back to stdout when SMTP is not configured.

### 2.4 Demo Credentials Exposed

The login page at `/login` displays hardcoded demo credentials:
```
demo@mimirlabs.net / demo1234
```
These must be removed or gated behind an environment variable before production.

---

## 3. Marketing Site & Portal (mimirlabs)

### 3.1 Public Pages — Complete

| Page | Status | Notes |
|------|--------|-------|
| Home `/` | ✓ | Hero, features grid, CTA |
| Pricing `/pricing` | ✓ | Starter/Pro/Enterprise with module pricing |
| Features `/features` | ✓ | Module grid with descriptions |
| Modules `/modules/[slug]` | ✓ | 12 dynamic module pages |
| About `/about` | ✓ | Company info |
| Cart `/cart` | ✓ | Module selection cart |
| Checkout `/checkout` | ⚠️ | Square integration (sandbox only) |
| Quiz `/quiz` | ✓ | Module selector quiz |
| EULA/Terms/Privacy | ✓ | Legal pages |

### 3.2 Auth Pages — Partially Complete

| Page | UI | Backend | Issue |
|------|-----|---------|-------|
| Login | ✓ | ✓ | Demo credentials shown |
| Signup | ✓ | ✓ | No email verification |
| Forgot Password | ✓ | ⚠️ | No email sent (logs token) |
| Reset Password | ✓ | ⚠️ | Works if you have the token |

### 3.3 Portal Pages — Mixed

| Page | UI | Real Data | Issue |
|------|-----|-----------|-------|
| Dashboard `/portal` | ✓ | ⚠️ | Health metrics all simulated/hardcoded |
| Team `/portal/team` | ✓ | ✓ | Fully functional (invite, role change, delete) |
| Subscription `/portal/subscription` | ✓ | ❌ | No API calls; billing history hardcoded |
| Settings `/portal/settings` | ✓ | ✓ | Profile/password/delete all work |
| Support `/portal/support` | ✓ | ✓ | Ticket creation works, no replies/detail view |
| Service Requests `/portal/service-requests` | ✓ | ✓ | Creation works, no status tracking |

### 3.4 Portal API Gaps

| Missing Feature | Impact |
|----------------|--------|
| No order creation after payment | Checkout succeeds but nothing recorded |
| No contract webhook handler | Can't detect when customer signs |
| No subscription change workflow | Users can't upgrade/downgrade |
| No seat management | Can't add/remove seats |
| No audit logging | No record of who did what |
| No pagination on any list endpoint | Will break with scale |
| No real health metrics | Dashboard shows fake data |

### 3.5 Session & Auth Gaps

| Issue | Risk |
|-------|------|
| JWT stored in `httpOnly` cookie (good) but no refresh token | Session dies after 7 days silently |
| No token revocation on logout | Stolen cookie valid for 7 days |
| No rate limiting on auth endpoints | Brute force possible |
| No MFA/2FA | Single factor only |
| No email verification on signup | Fake emails accepted |
| No account lockout after failed logins | No protection against credential stuffing |

---

## 4. ERP Web Application (yggdrasil/web-app)

### 4.1 Architecture

- **Framework:** Next.js 14.2.35, React 18.3.1, TypeScript strict
- **State:** Zustand + React Query
- **HTTP:** Axios with JWT in `localStorage` (XSS risk)
- **UI:** Tailwind CSS with custom "yggdrasil" green theme
- **Charts:** Recharts
- **Maps:** MapLibre GL

### 4.2 Module Pages — All Scaffolded, Varying Depth

| Module | Tabs | CRUD | Special Features | Key Gaps |
|--------|------|------|-----------------|----------|
| CRM | 6 (Accounts, Contacts, Opportunities, Leads, Quotes, Orders) | ✓ | Lead management | No contact timeline, no activity logging |
| Sales | 3 (Quotes, Orders, Invoices) | ✓ | QuoteBuilder, DocumentBuilder | No Quote→SO conversion button |
| Purchasing | 6 (POs, Suppliers, Receipts, RFI, RFQ, RFP) | ✓ | DocumentBuilder for POs | No per-line receiving |
| Manufacturing | 5 (WOs, Shop Floor, Work Centers, Operations, MRP) | ✓ | Shop floor status view | No real-time updates, no WO costing |
| Warehouse | 4 (Inventory, Transactions, Pick Lists, Cycle Counts) | ✓ | Cycle count workflow | No barcode scanning, no bin management |
| Finance | 4 (GL, Journal Entries, Invoices, Payments) | ✓ | DocumentBuilder for JEs | No reconciliation, no tax config |
| Projects | 3 (Projects, Tasks, Time Entries) | ✓ | — | No Gantt chart, no milestones |
| Quality | 4 (8D, CAPA, NCR, Audits) | ✓ | — | No inspection plans |
| Service | 4 (Tickets, Orders, RMA, Warranty) | ✓ | — | No SLA tracking |
| PLM | 6 (EBOMs, MBOMs, Routings, ECOs, Where-Used, Eng Report) | ✓ | Option groups, revision control | No BOM cost roll-up |
| HR | 5 (Employees, Payroll, Time, Performance, Benefits) | ✓ | — | No benefits portal |
| Admin | 7 (Users, Roles, Perms, User-Roles, Settings, Audit, Migrations) | ✓ | Data migration wizard | — |
| Workflows | 2 (Templates, Instances) | ✓ | — | No visual workflow editor |
| Territories | 1 | ✓ | MapLibre boundary drawing | — |
| Reports | 2 (Overview, Empty Fields) | ⚠️ | Data quality checker | Overview is placeholder |

### 4.3 Critical Missing Features

| Feature | Status | Impact |
|---------|--------|--------|
| **WebSocket client** | NOT IMPLEMENTED | No real-time updates anywhere (shop floor, dashboards) |
| **Session/token refresh** | NOT IMPLEMENTED | Long sessions silently expire |
| **Global error boundary** | NOT IMPLEMENTED | Unhandled errors crash the page |
| **Pagination** | NOT IMPLEMENTED in web-app | Large tables will cause UI lag |
| **Global search / Cmd+K** | NOT IMPLEMENTED | No cross-module navigation |
| **User profile/settings** | NOT IMPLEMENTED | No way to change profile |
| **PDF export/print** | NOT IMPLEMENTED | Can't print POs, invoices, quotes |
| **File attachments** | NOT IMPLEMENTED | No drawings, photos, documents |
| **Notifications/toast** | NOT IMPLEMENTED | No user feedback on success/failure |
| **Bulk operations** | NOT IMPLEMENTED | No multi-select, batch delete/update |
| **Relationship navigation** | NOT IMPLEMENTED | Can't click FK to navigate |
| **Saved filters/views** | NOT IMPLEMENTED | No persistent filter state |

### 4.4 Dashboard

The home page (`/page.tsx`) shows a module grid with 4 hardcoded stats:
- Active Modules: **10** (hardcoded)
- Database Tables: **101** (hardcoded)
- API Endpoints: **24** (hardcoded)
- Server Status: **"Not connected"** (hardcoded red)

None of these are queried from the backend.

### 4.5 Auth Token Storage

Auth tokens are stored in `localStorage` (client-side JavaScript accessible). This is an XSS vulnerability — if any script injection occurs, tokens can be stolen. Should be moved to `httpOnly` cookies.

---

## 5. ERP Backend (yggdrasil/server)

### 5.1 Architecture

- **Language:** C++17 with Qt 6.2+
- **HTTP Server:** Port 8080 (150+ endpoints)
- **WebSocket Server:** Port 8081 (B2B real-time events)
- **Database:** PostgreSQL (126 tables, 12 views, 150+ indexes)
- **Federation:** RedPanda (Kafka-compatible) via Cloudflare tunnel

### 5.2 Module Route Coverage

22 route files implementing 150+ endpoints. All modules have GET (list/detail) and POST (create). Most have PUT (update). Few have DELETE.

### 5.3 Backend Gaps

| Gap | Details |
|-----|---------|
| DELETE endpoints missing on most modules | Only a few modules support delete |
| No file upload endpoint | No attachment storage or retrieval |
| Quality inspection plans incomplete | Tables exist, no route handlers |
| Project milestones/phases | Tables exist, no route handlers |
| Service parts used | Table exists, no route handler |
| Shipment lines | Table exists, not exposed in API |
| Pick list lines | Table exists, not exposed in API |
| WO material issuing | Read-only in API, no issue/return actions |
| WO operation clock-in/out | Not implemented |
| BOM cost roll-up | Not implemented |
| Multi-currency | Not implemented |

---

## 6. Business Flow Gaps

### 6.1 Order-to-Cash (BROKEN)

```
Quote ──[MANUAL RE-ENTRY]──> Sales Order ──[MANUAL]──> Invoice ──[MANUAL]──> Payment
```

| Step | Server Endpoint | UI Button | Status |
|------|----------------|-----------|--------|
| Quote → Sales Order | Exists | ❌ Missing | Manual re-entry required |
| Sales Order → Invoice | Exists | ❌ Missing | Manual re-entry required |
| Invoice → Payment | Payment exists | ❌ No "Apply Payment" | Manual matching |

### 6.2 Procure-to-Pay (BROKEN)

```
MRP ──[MANUAL]──> PO ──[HEADER ONLY]──> Receiving ──[NO LINK]──> Inspection
```

| Step | Server Endpoint | UI | Status |
|------|----------------|----|--------|
| MRP → Purchase Order | MRP planned orders exist | ❌ No "Confirm" button | Manual PO creation |
| PO → Line-level Receiving | ❌ Missing | ❌ Missing | Header-level only |
| Receiving → Inspection | ❌ Missing | ❌ Missing | Not integrated |

### 6.3 Make-to-Order (BROKEN)

```
SO ──[MANUAL]──> WO ──[NO ISSUE]──> Material ──[NO CLOCK]──> Operations ──[NO RECEIPT]──> FG
```

| Step | Server Endpoint | UI | Status |
|------|----------------|----|--------|
| SO → Work Order | ❌ Missing | ❌ Missing | Manual WO creation |
| WO → Material Issue | Read-only | ❌ Missing | Can't issue material |
| WO → Operation Control | ❌ Missing | ❌ Missing | No clock-in/out |
| WO → Finished Goods Receipt | ❌ Missing | ❌ Missing | No inventory receipt |
| WO → Cost Roll-up | ❌ Missing | ❌ Missing | No costing |

---

## 7. Module Scorecards

Scores from manufacturing operations audit perspective (1-10):

| Module | Desktop | Web-App | Backend API | Overall | Priority Gaps |
|--------|---------|---------|-------------|---------|---------------|
| PLM | 8/10 | 7/10 | 8/10 | **7.5** | No standalone Part creation; no BOM cost roll-up |
| Admin | 8/10 | 8/10 | 8/10 | **8.0** | Solid |
| CRM | 7/10 | 6/10 | 7/10 | **6.5** | No activity logging, no pipeline view |
| Sales | 7/10 | 7/10 | 7/10 | **7.0** | No Quote→SO→Invoice flow buttons |
| Purchasing | 7/10 | 7/10 | 6/10 | **6.5** | No line-level receiving |
| Service | 6/10 | 7/10 | 5/10 | **6.0** | Desktop missing Service Orders; thin API |
| Quality | 7/10 | 6/10 | 5/10 | **6.0** | No inspection plans/results |
| HR | 7/10 | 6/10 | 7/10 | **6.5** | Desktop missing Benefits |
| Finance | 6/10 | 7/10 | 7/10 | **6.5** | No reconciliation, no tax config |
| Manufacturing | 6/10 | 5/10 | 7/10 | **6.0** | No WO costing, material issue, op control |
| Warehouse | 4/10 | 4/10 | 6/10 | **4.5** | No location/bin management, no barcode |
| Projects | 5/10 | 5/10 | 5/10 | **5.0** | No Gantt, no milestones/phases |
| Logistics | 5/10 | 5/10 | 7/10 | **5.5** | No pick-pack-ship workflow |
| Reports | 4/10 | 3/10 | 7/10 | **4.5** | 16 backend reports; web-app shows 0 charts |

---

## 8. Testing & CI/CD

### 8.1 Current Test Coverage

| Component | Framework | Test Files | Tests | Coverage |
|-----------|-----------|------------|-------|----------|
| C++ Server | Catch2 | ~5 | 21 | Cache + Validator only |
| Desktop Client | — | 0 | 0 | None |
| Web-App | Vitest | 3 | ~14 | API client + geo + CrudPanel |
| Marketing Site | — | 0 | 0 | None |
| Integration | Custom TS runner | 106 stories | ~200+ | Requires running server |

### 8.2 What's Not Tested

- AuthManager, Logger, RateLimiter (0 unit tests)
- All desktop QML UI (0 tests)
- All web-app React components except CrudPanel (0 tests)
- All marketing site pages and API routes (0 tests)
- No E2E browser tests (no Playwright/Cypress)
- Integration tests don't run in CI (require server + DB)

### 8.3 CI/CD

- GitHub Actions workflows exist in `infra/ci/`
- Only unit tests run in CI
- No staging environment
- No automated deployment pipeline
- No lint/type-check gates

---

## 9. Infrastructure & DevOps

### 9.1 VPS Stack (Central Broker)

Docker Compose with 7 services:
- PostgreSQL 16 (mesh DB)
- Caddy 2 (reverse proxy)
- Marketing site (Next.js)
- ERP portal (Next.js)
- RedPanda (Kafka broker)
- RedPanda Console (web UI)
- Cloudflare tunnel (ingress)

### 9.2 Deployment Gaps

| Gap | Impact |
|-----|--------|
| No database backup schedule | Data loss risk |
| No PITR (Point-in-Time Recovery) | Can't recover from errors |
| No health monitoring integration | No alerts when services crash |
| No log aggregation | Logs scattered across containers |
| No SSL/TLS documentation | Server has SSL fields but no guide |
| No migration runner | Raw SQL files, no version tracking |
| Seed scripts use insecure default password | `yggdrasil_dev` hardcoded |
| No blue-green or canary deployment | Downtime during updates |

### 9.3 Security Gaps

| Gap | Severity |
|-----|----------|
| Auth token in `localStorage` (web-app) | High — XSS vulnerability |
| No rate limiting on marketing site auth | High — brute force |
| No email verification for signups | Medium — fake accounts |
| No account lockout | Medium — credential stuffing |
| No MFA/2FA support | Medium — single factor only |
| Demo credentials in login page | Medium — should be env-gated |
| 7-day JWT with no revocation | Medium — stolen tokens |

---

## 10. Prioritized Action Items

### P0 — Blocking (Before any user)

| # | Item | Repo | Effort |
|---|------|------|--------|
| 1 | Rebuild and redeploy marketing site (sharp + fresh build) | mimirlabs | 10 min |
| 2 | Swap DAL from in-memory Maps to Prisma | mimirlabs | 4-6 hr |
| 3 | Implement email sending (nodemailer for resets, invites, confirmations) | mimirlabs | 2-3 hr |
| 4 | Remove demo credentials from login page (env-gate it) | mimirlabs | 15 min |
| 5 | Add Order + Contract DAL functions (checkout creates nothing) | mimirlabs | 2 hr |
| 6 | Add AuditLog DAL functions | mimirlabs | 1 hr |
| 7 | Fix subscription page (wire to real data) | mimirlabs | 2-3 hr |
| 8 | Add WebSocket client to web-app | yggdrasil | 3-4 hr |
| 9 | Move web-app auth token to httpOnly cookie | yggdrasil | 2 hr |
| 10 | Add global error boundary to web-app | yggdrasil | 1 hr |

### P1 — Critical (Before first paying customer)

| # | Item | Repo | Effort |
|---|------|------|--------|
| 11 | Wire Quote→SO→Invoice conversion buttons | yggdrasil | 3 hr |
| 12 | Add DELETE endpoints across all modules | yggdrasil | 4 hr |
| 13 | Implement pagination in web-app CrudPanel | yggdrasil | 2 hr |
| 14 | Add real dashboard stats (query from backend) | yggdrasil | 2 hr |
| 15 | Add real portal health metrics (query tenant connection) | mimirlabs | 3 hr |
| 16 | Implement session/token refresh | both | 3 hr |
| 17 | Add file upload/attachment system | yggdrasil | 6-8 hr |
| 18 | Connect Reports page to 16 backend report types | yggdrasil | 4-6 hr |
| 19 | Add PDF export for documents (POs, invoices, quotes) | yggdrasil | 4-6 hr |
| 20 | Fill Quality inspection plans (tables exist, no routes) | yggdrasil | 3 hr |

### P2 — Important (Before pilot deployment)

| # | Item | Repo | Effort |
|---|------|------|--------|
| 21 | Add WO material issuing and operation control | yggdrasil | 4-6 hr |
| 22 | Add per-line receiving for Purchasing | yggdrasil | 3 hr |
| 23 | Fill Project module gaps (milestones, phases, Gantt) | yggdrasil | 6 hr |
| 24 | Fill Service module gaps (service orders, SLA tracking) | yggdrasil | 4 hr |
| 25 | Add user profile/settings page to web-app | yggdrasil | 2 hr |
| 26 | Add global search / command palette | yggdrasil | 4 hr |
| 27 | Add commission tracking UI to Sales | yggdrasil | 3 hr |
| 28 | Add banking sub-module to Finance | yggdrasil | 4 hr |
| 29 | Add logout button (currently missing from web-app) | yggdrasil | 30 min |
| 30 | Build notification/toast system | yggdrasil | 2 hr |

### P3 — Polish (Before market entry)

| # | Item | Repo | Effort |
|---|------|------|--------|
| 31 | Increase test coverage (target: 60%+ per component) | all | 20+ hr |
| 32 | Build setup.sh bootstrap script | yggdrasil | 3 hr |
| 33 | Schema freeze and production installer | yggdrasil | 4 hr |
| 34 | Configure Square payment for production | mimirlabs | 1 hr |
| 35 | Configure BoldSign contracts for production | mimirlabs | 1 hr |
| 36 | Add CI/CD pipeline (lint, type-check, test, build, deploy) | yggdrasil | 6 hr |
| 37 | Add Playwright E2E tests for critical flows | yggdrasil | 8 hr |
| 38 | Set up database backup schedule with PITR | infra | 3 hr |
| 39 | Add Prometheus/Grafana monitoring | infra | 4 hr |
| 40 | Add log aggregation (Loki or similar) | infra | 3 hr |

---

## Appendix A: Files Modified in This Audit

| File | Change |
|------|--------|
| `mimirlabs/website/package.json` | Added `sharp@0.34.5` dependency |
| `mimirlabs/website/ecosystem.config.cjs` | New PM2 ecosystem config |
| `mimirlabs/website/.gitignore` | Added `/logs` for PM2 |
| `mimirlabs/website/.dockerignore` | Excluded PM2 files from Docker |

## Appendix B: Architecture Diagram

```
                          CENTRAL VPS (Hetzner CPX31)
 ┌────────────────────────────────────────────────────────────────────┐
 │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────────────┐  │
 │  │ Caddy    │  │ PostgreSQL│  │ RedPanda │  │ Cloudflare Tunnel│  │
 │  │ :80/:8081│  │ :5432    │  │ :9092    │  │ (ingress)        │  │
 │  └────┬─────┘  └─────┬────┘  └────┬─────┘  └────────┬─────────┘  │
 │       │              │            │                  │             │
 │  ┌────┴─────┐  ┌─────┴────┐      │                  │             │
 │  │ Website  │  │ Portal   │      │                  │             │
 │  │ :3000    │  │ :3000    │      │                  │             │
 │  │ (Next14) │  │ (Next15) │      │                  │             │
 │  └──────────┘  └──────────┘      │                  │             │
 └──────────────────────────────────┼──────────────────┼─────────────┘
                                    │                  │
         ┌──────────────────────────┼──────────────────┘
         │     TENANT SITE          │
 ┌───────┼──────────────────────────┼────────────────────────────────┐
 │  ┌────┴─────┐  ┌──────────┐  ┌──┴───────┐  ┌──────────────────┐  │
 │  │ C++ Svr  │  │ PostgreSQL│  │ Go       │  │ Desktop Client   │  │
 │  │ :8080    │  │ :5432    │  │ Sidecar  │  │ (Qt 6)           │  │
 │  │ :8081 WS │  │ (101 tbl)│  │ (tunnel) │  │                  │  │
 │  └──────────┘  └──────────┘  └──────────┘  └──────────────────┘  │
 └───────────────────────────────────────────────────────────────────┘
```

## Appendix C: Database Model Inventory

**Yggdrasil ERP Schema:** 126 tables across 15 sections
**Marketing Site Schema (Prisma):** 13 models

See `yggdrasil/database/schema/yggdrasil_complete_schema.sql` and `mimirlabs/website/prisma/schema.prisma` for full details.
